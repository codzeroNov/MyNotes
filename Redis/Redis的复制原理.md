在Redis中，用户可以通过执行SLAVEOF命令或者设置slaveof选项，让一个服务器去复制（replicate）另一个服务器，我们称呼被复制的服务器为主服务器（master），对主服务器进行复制的服务器则被成为从服务器（slave）。

## 旧版复制功能的实现

Redis的2.8版本前的复制功能分为同步（sync）和命令传播（command propagate）。

**同步**：用于将从服务器的数据库状态更新至主服务器当前所处的数据库状态。

**命令传播**：用于主服务器的数据库状态被修改，导致主从服务器的数据库状态出现不一致时，让主从服务器的数据库状态重回一致。

#### 同步

用于将从服务器更新至主服务器状态。

1. 从服务器向主服务器发送SYNC命令。
2. 受到SYNC命令的主服务器执行BGSAVE命令，在后台生成一个RDB文件，并使用一个缓冲区记录从现在开始执行的所有写命令。
3. 当主服务器的BGSAVE命令执行完毕时，RDB文件会发送给从服务器，从服务器接受并载入RDB文件。
4. 主服务器将记录在缓冲区里的所有写命令发送给从服务器，从服务器执行这些命令

#### 命令传播

在同步操作执行完后，主服务器每次接收到的写命令会发送给从服务器。

#### 旧版复制功能的缺陷

在Redis中，从服务器对主服务器的复制分为以下两种：

**初次复制**：从服务器以前没有复制过任何主服务器，或从服务器当前复制的主服务器和上一次不同。

**断线后复制**：处于命令传播阶段的主从服务器因为网络原因而中断了复制，但从服务器通过自动重连接又重新连上了主服务器，并继续复制主服务器。

**缺陷**：对于初次复制来说，使用旧版的复制没有问题。但断线后复制依然会让主服务器全量地生成RDB文件，从服务器也要重头执行RDB文件，十分消耗网络带宽和CPU，影响主服务器对客户端请求的响应，从服务器也会阻塞，效率低下。

## 新版复制功能的实现

PSYNC代替了SYNC。PSYNC命令具有完整重同步（full resynchronization）和部分重同步（partial resynchronization）。

**完整重同步用于初次复制**。完整重同步执行步骤和SYNC执行步骤基本一样。

**部分重同步用于断线后复制**。主服务器只会将断开连接期间的写命令发送到重新连接上来的从服务器。

通过降低断线后复制的资源量，提高同步的性能和效率。

#### 部分重同步的实现

部分重同步功能由以下三部分构成：

1. 主服务器的复制偏移量（replication offset）和从服务器的复制偏移量。
2. 主服务器的复制积压缓冲区（replication backlog）。
3. 服务器的运行ID（run ID）。

**复制偏移量**：主从服务器通过比较复制偏移量来确认状态是否一致。

**复制积压缓冲区**：复制积压缓冲区是由主服务器维护的固定长度的先进先出队列。当主服务器进行命令传播时，不仅将命令发送给所有从服务器，还会将命令写入复制积压缓冲区。

**服务运行ID**：每个Redis服务器都有自己的运行ID。

![主服务器向从服务器和复制积压缓冲区写数据](D:\DOCS\REDIS\PICS\主服务器向从服务器和复制积压缓冲区写数据.png)

当从服务器连上主服务器时，从服务器会将自身的复制偏移量通过PSYNC发给主服务器。主服务器检查复制积压缓冲区，若偏移量之后的数据在复制积压缓冲区之中，则执行部分重同步。否则执行完整重同步。

#### PSYNC的实现

![PSYNC执行时可能遇到的情况](D:\DOCS\REDIS\PICS\PSYNC执行时可能遇到的情况.png)

#### 复制的实现

1. 设置主服务器的地址和端口
2. 建立套接字连接
3. 发送PING命令
4. 身份验证
5. 发送端口信息
6. 同步
7. 命令传播

#### 心跳机制

在命令传播阶段，从服务器默认会以每秒一次的频率，向主服务器发送命令：`REPLONF ACK <replication_offset>` ，其中replication_offset是从服务器当前的复制偏移量。

发送REPLCONF ACK命令对于主从服务器有三个作用：

+ 检测主从服务器的网络连接状态。
+ 辅助实现min-slaves选项。
+ 检测命令丢失。

> 1. 如果主服务器超过一秒没收到从服务器发来的REPLCONF ACK命令，那么主服务器就知道主从服务器之间的连接出现了问题。
>
> 2. min-slaves-to-write和min-slaves-max-lag两个选项可以防止主服务器在不安全的情况下执行写命令。如：
>
>    min-slaves-to-write 3
>
>    min-slaves-max-lag 10
>
>    那么从服务器少于3个，或三个从服务器的延迟都大于或等于10秒时，主服务器将拒绝写命令。
>
> 3. 若主服务器传播给从服务器的写命令丢失，那么从服务器给主服务器发送REPLCONF ACK时，主服务器将发掘从服务器的复制偏移量少于自己的复制偏移量，然后主服务器就会根据从服务器提交的复制偏移量，在复制积压缓冲区里找到缺少的数据，并发给从服务器。